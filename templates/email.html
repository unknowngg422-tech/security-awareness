{% extends "base.html" %}
{% block title %}ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„{% endblock %}

{% block head %}
<style>
  /* Ø«ÙŠÙ…ÙŠÙ†: Ø¯Ø§ÙƒÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ + Ù„Ø§ÙŠØª Ø¹Ù†Ø¯ data-theme="light" */
  :root{
    --bg:#0f172a; --card:#0b1220; --text:#e6f0ff; --muted:#94a3b8;
    --border:1px solid rgba(148,163,184,.18);
  }
  html[data-theme="light"]{
    --bg:#f6fbff; --card:#ffffff; --text:#0f172a; --muted:#6b7280;
    --border:1px solid #e6eef6;
  }
  body{ background:var(--bg); color:var(--text); }

  /* Ù†Ø®ÙÙŠ Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± Ù‡Ù†Ø§ØŒ ÙˆÙ†ÙƒØªÙÙŠ Ø¨Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
  .navbar{ display:none !important; }

  /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© */
  #mail-page{ max-width: 860px; margin: 26px auto 34px; padding: 0 16px; }

  .title{ display:flex; gap:10px; align-items:center; justify-content:center; margin:4px 0 6px; }
  .title .ico{ font-size:30px; filter:drop-shadow(0 6px 16px rgba(0,0,0,.12)); }
  .subtitle{ text-align:center; color:var(--muted); margin:0 0 16px; }

  /* ÙƒØ±Øª + Ø¹Ù†Ø§ØµØ± */
  .card{ background:var(--card); border:var(--border); border-radius:18px; box-shadow:0 14px 30px rgba(0,0,0,.08); padding:16px; }

  .grid{ display:grid; gap:10px; }
  @media (min-width:720px){
    .grid.cols-2{ grid-template-columns: 2fr 1fr; }
  }
  .input{ width:100%; padding:12px 14px; border-radius:12px; border:var(--border); background:var(--card); color:var(--text); outline:none; transition:.2s; }
  .input:focus{ box-shadow:0 0 0 3px rgba(99,102,241,.18); border-color:rgba(99,102,241,.45); }
  textarea.input{ min-height:160px; resize:vertical; }

  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .icon-btn, .btn{
    padding:11px 14px; border-radius:12px; border:var(--border);
    background:var(--card); color:var(--text); cursor:pointer; transition:.2s;
  }
  .btn.primary{
    border:none; color:#fff; background:linear-gradient(90deg,#6366F1,#3B82F6);
    box-shadow:0 12px 24px rgba(59,130,246,.25); font-weight:800;
  }
  .icon-btn:hover, .btn:hover{ transform: translateY(-1px); }
  .btn.loading{ opacity:.7; cursor:not-allowed; }

  /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ */
  .meter{ height:10px; background:rgba(125,125,125,.18); border:var(--border);
          border-radius:999px; overflow:hidden; margin:10px 0 8px; }
  .meter .fill{ height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#10b981); transition:width .35s; }

  /* Ø§Ù„Ø´Ø§Ø±Ø© ÙˆØ§Ù„chips */
  .verdict{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .badge{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--card); font-weight:900; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{ padding:6px 10px; border-radius:999px; border:var(--border); background:var(--card); }
  .chip:hover{ transform: translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.12); }

  /* Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙƒÙ„Ù…Ø§Øª */
  .hl{ background: rgba(239,68,68,.12); color: var(--text); border-radius:6px; padding:2px 4px; }

  /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ: Ø±Ø¬ÙˆØ¹ + Ø«ÙŠÙ… */
  .topbar{ display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:8px; }
  .back{ display:inline-flex; align-items:center; gap:6px; font-weight:700; }
  .back .arr{ transform: scaleX(-1); }
  .theme{
    padding:8px 12px; border-radius:12px; border:var(--border);
    background:var(--card); color:var(--text); cursor:pointer; font-weight:800;
  }
</style>
{% endblock %}

{% block content %}
<div id="mail-page">

  <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ: Ø±Ø¬ÙˆØ¹ + ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ… -->
  <div class="topbar">
    <a class="back" href="{{ url_for('index') }}"><span class="arr">â†©</span> <span data-i18n="quiz_back">Ø±Ø¬ÙˆØ¹</span></a>
    <button id="page-theme" class="theme" type="button" data-i18n="quiz_theme">ğŸŒ™ ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†</button>
  </div>

  <div class="title">
    <div class="ico">ğŸ“§</div>
    <h1 class="page-title" style="margin:0" data-i18n="mail_title">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h1>
  </div>
  <p class="subtitle" data-i18n="mail_subtitle">Ø£Ø¯Ø®Ù„ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØµÙŠÙ‘Ø¯ ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ù„.</p>

  <div id="mail-card" class="card">

    <!-- Ø£Ø¯ÙˆØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
    <div class="row" style="justify-content:flex-end; margin-bottom:6px">
      <button id="pasteBtn" class="icon-btn" title="Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©"><span data-i18n="btn_paste">ğŸ“‹ Ù„ØµÙ‚</span></button>
      <button id="clearBtn" class="icon-btn" title="Ù…Ø³Ø­"><span data-i18n="btn_clear">âœ– Ù…Ø³Ø­</span></button>
    </div>

    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ -->
    <div class="grid cols-2">
      <input id="sender"  class="input" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø±Ø³Ù„ (Ù…Ø«Ø§Ù„: admin@paypal.com)" data-i18n-placeholder="mail_sender_ph">
      <input id="subject" class="input" type="text" placeholder="Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹" data-i18n-placeholder="mail_subject_ph">
    </div>
    <textarea id="body" class="input" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©" data-i18n-placeholder="mail_body_ph"></textarea>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ -->
    <div class="row" style="justify-content:flex-end; margin-top:6px">
      <button id="analyzeBtn" class="btn primary" data-i18n="btn_analyze">ØªØ­Ù„ÙŠÙ„</button>
    </div>

    <!-- Ø¹Ø¯Ø§Ø¯ -->
    <div class="meter" id="meter" hidden>
      <div id="bar" class="fill"></div>
    </div>

    <!-- Ù†ØªÙŠØ¬Ø© Ù…Ø®ØªØµØ±Ø© + Chips -->
    <div class="verdict" id="verdictWrap" hidden>
      <span id="badge" class="badge">â€”</span>
      <span id="scoreText" class="muted"><span data-i18n="score_label">Ø§Ù„Ø¯Ø±Ø¬Ø©:</span> â€”</span>
    </div>
    <div id="chips" class="chips" hidden></div>

    <!-- Ø¥Ø¨Ø±Ø§Ø² ÙƒÙ„Ù…Ø§Øª Ù…Ø´Ø¨ÙˆÙ‡Ø© Ù…Ù† Ø§Ù„Ù†Øµ -->
    <div id="hlBox" class="card" style="margin-top:10px; display:none">
      <div class="muted" style="margin-bottom:6px" data-i18n="mail_words_noticed">ÙƒÙ„Ù…Ø§Øª Ù„ÙÙˆØ­Ø¸Øª ÙÙŠ Ø§Ù„Ù†Øµ:</div>
      <div id="hlWords"></div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* Ø²Ø± Ø§Ù„Ù„Ø§ÙŠØª/Ø§Ù„Ø¯Ø§Ø±Ùƒ */
(function(){
  const KEY='page_theme';
  const root=document.documentElement;
  const btn=document.getElementById('page-theme');
  function apply(mode){
    root.setAttribute('data-theme', mode);
    localStorage.setItem(KEY, mode);
    // Ø§Ù„Ù†Øµ ÙŠÙØªØ±Ø¬Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ø¨Ø± i18nØŒ Ù„ÙƒÙ† Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ fallback Ø¨ØµØ±ÙŠ Ù‡Ù†Ø§
    const isDark = (mode==='dark');
    if(!btn.dataset.i18n){ btn.textContent = isDark ? 'â˜€ï¸ ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ' : 'ğŸŒ™ ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ†'; }
  }
  const saved = localStorage.getItem(KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  apply(saved);
  btn.addEventListener('click', ()=> apply(root.getAttribute('data-theme')==='dark' ? 'light' : 'dark'));
  window.addEventListener('storage', e=>{ if(e.key===KEY && (e.newValue==='dark'||e.newValue==='light')) apply(e.newValue); });
})();
</script>

<script>
/* ===== Ø·Ø¨Ù‚Ø© i18n Ù„Ù„ØµÙØ­Ø© (ØªØ³ØªÙ…Ø¯ Ø§Ù„Ù„ØºØ© Ù…Ù† localStorage('site_lang')) ===== */
(function(){
  const LANG_KEY = 'site_lang';
  let DICT = {};
  let CUR = localStorage.getItem(LANG_KEY) || 'ar';

  function t(key, params){
    let s = (DICT && DICT[key]) || '';
    if(params){
      for(const k in params){ s = s.replaceAll(`{${k}}`, params[k]); }
    }
    return s || '';
  }

  function applyTextNodes(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      const v = t(key);
      if(v) el.textContent = v;
    });
  }

  function applyPlaceholders(){
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const key = el.getAttribute('data-i18n-placeholder');
      const v = t(key);
      if(v) el.setAttribute('placeholder', v);
    });
  }

  async function loadDict(){
    CUR = localStorage.getItem(LANG_KEY) || 'ar';
    try{
      const res = await fetch(`/static/lang/${CUR}.json`);
      DICT = await res.json();
    }catch(_){
      DICT = {};
    }
    applyTextNodes();
    applyPlaceholders();
  }

  // Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù† (base.html)
  window.addEventListener('storage', e=>{
    if(e.key === LANG_KEY){
      loadDict();
      // ØªØ­Ø¯ÙŠØ« Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ùˆ ØªØºÙŠÙ‘Ø± Ù…Ù† base
      const lang = localStorage.getItem(LANG_KEY) || 'ar';
      document.documentElement.lang = lang;
      document.documentElement.dir  = (lang==='ar'?'rtl':'ltr');
    }
  });

  // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
  loadDict();

  // Ù†Ø¹Ø±Ù‘Ù Ø¯ÙˆØ§Ù„ ØªØ±Ø¬Ù…Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø©
  window.__mail_i18n__ = {
    t,
    verdictLabel(v){
      if(v==='Ø®Ø·Ø±' || v==='danger')   return t('verdict_danger') || 'Ø®Ø·Ø±';
      if(v==='Ù…Ø´Ø¨ÙˆÙ‡' || v==='suspicious') return t('verdict_suspicious') || 'Ù…Ø´Ø¨ÙˆÙ‡';
      if(v==='Ø¢Ù…Ù†' || v==='safe')     return t('verdict_safe') || 'Ø¢Ù…Ù†';
      return v || 'â€”';
    },
    // Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØµÙŠÙ‘Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    phishyWords(){
      // Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…ØµÙÙˆÙØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ
      if (Array.isArray(DICT['mail_phishy_words']) && DICT['mail_phishy_words'].length){
        return DICT['mail_phishy_words'].map(String).map(w=>w.toLowerCase());
      }
      return ['urgent','verify','update','reset','free','gift','win','bonus','password','bank','paypal','code','otp','confirm','click','login'];
    },
    labels:{
      scorePrefix(){ return t('score_label') || 'Ø§Ù„Ø¯Ø±Ø¬Ø©:'; },
      unable(){ return t('mail_unable') || 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„'; },
      enterData(){ return t('mail_enter_data') || 'Ø£Ø¯Ø®Ù„ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©'; },
      netOrFormat(){ return t('mail_check_net_or_format') || 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ØµÙŠØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.'; }
    }
  };
})();
</script>

<script>
(function(){
  const card   = document.getElementById('mail-card');
  const sender = document.getElementById('sender');
  const subject= document.getElementById('subject');
  const body   = document.getElementById('body');

  const analyze= document.getElementById('analyzeBtn');
  const paste  = document.getElementById('pasteBtn');
  const clearB = document.getElementById('clearBtn');

  const meter  = document.getElementById('meter');
  const bar    = document.getElementById('bar');

  const verdictWrap = document.getElementById('verdictWrap');
  const badge  = document.getElementById('badge');
  const scoreT = document.getElementById('scoreText');
  const chips  = document.getElementById('chips');

  const hlBox  = document.getElementById('hlBox');
  const hlWords= document.getElementById('hlWords');

  // ØªÙØ³Ø­Ø¨ Ù…Ù† Ø·Ø¨Ù‚Ø© i18n
  function phishyList(){ return (window.__mail_i18n__ && window.__mail_i18n__.phishyWords()) || ['urgent','verify','update']; }
  function L(key, params){ return (window.__mail_i18n__ && window.__mail_i18n__.t(key, params)) || ''; }
  function verdictLabel(v){ return (window.__mail_i18n__ && window.__mail_i18n__.verdictLabel(v)) || v; }
  const LBL = {
    scorePrefix: ()=> (window.__mail_i18n__ && window.__mail_i18n__.labels.scorePrefix()) || 'Ø§Ù„Ø¯Ø±Ø¬Ø©:',
    unable:      ()=> (window.__mail_i18n__ && window.__mail_i18n__.labels.unable())      || 'ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„',
    enterData:   ()=> (window.__mail_i18n__ && window.__mail_i18n__.labels.enterData())   || 'Ø£Ø¯Ø®Ù„ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©',
    netOrFormat: ()=> (window.__mail_i18n__ && window.__mail_i18n__.labels.netOrFormat()) || 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ØµÙŠØºØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.'
  };

  function setLoading(on){
    meter.hidden = !on;
    analyze.disabled = on;
    analyze.classList.toggle('loading', on);
    if(on){ bar.style.width = '30%'; }
  }

  function colorize(v){
    const localV = verdictLabel(v);
    // Ù†Ù„ÙˆÙ‘Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ (danger/suspicious/safe)
    if(localV === verdictLabel('Ø®Ø·Ø±') || localV.toLowerCase()==='danger'){
      badge.style.background = 'rgba(239,68,68,.12)';
      badge.style.color      = '#ef4444';
      badge.style.borderColor= 'rgba(239,68,68,.40)';
    }else if(localV === verdictLabel('Ù…Ø´Ø¨ÙˆÙ‡') || localV.toLowerCase()==='suspicious'){
      badge.style.background = 'rgba(245,158,11,.14)';
      badge.style.color      = '#f59e0b';
      badge.style.borderColor= 'rgba(245,158,11,.40)';
    }else{
      badge.style.background = 'rgba(16,185,129,.12)';
      badge.style.color      = '#10b981';
      badge.style.borderColor= 'rgba(16,185,129,.35)';
    }
    badge.textContent = localV || 'â€”';
  }

  function resetUI(){
    verdictWrap.hidden = true;
    chips.hidden = true;
    chips.innerHTML = '';
    scoreT.innerHTML = `<span data-i18n="score_label">${LBL.scorePrefix()}</span> â€”`;
    hlBox.style.display = 'none';
    hlWords.innerHTML = '';
  }

  function addChip(text){
    const span = document.createElement('span');
    span.className = 'chip';
    span.textContent = text;
    chips.appendChild(span);
    chips.hidden = false;
  }

  function highlightBadWords(text){
    const list = phishyList();
    const found = [];
    const lowered = text.toLowerCase();
    list.forEach(w=>{ if(lowered.includes(w)) found.push(w); });
    if(found.length){
      hlBox.style.display = 'block';
      hlWords.innerHTML = found.map(w=>`<span class="hl">${w}</span>`).join(' ');
    }else{
      hlBox.style.display = 'none';
    }
  }

  async function run(){
    const s  = (sender.value||'').trim();
    const su = (subject.value||'').trim();
    const b  = (body.value||'').trim();

    if(!s && !su && !b){
      resetUI();
      verdictWrap.hidden = false;
      colorize('Ù…Ø´Ø¨ÙˆÙ‡');
      badge.textContent = LBL.enterData();
      return;
    }

    resetUI();
    setLoading(true);

    try{
      const r = await fetch("{{ url_for('api_email_check') }}", {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({sender:s, subject:su, body:b})
      });
      const data = await r.json();

      bar.style.width = '85%';

      colorize(data.verdict || 'Ù…Ø´Ø¨ÙˆÙ‡');

      const scoreNum = (typeof data.score === 'number') ? data.score : null;
      scoreT.innerHTML = `<span data-i18n="score_label">${LBL.scorePrefix()}</span> ${scoreNum!==null ? (scoreNum + '%') : 'â€”'}`;
      verdictWrap.hidden = false;

      (data.reasons||[]).forEach(addChip);

      if(b) highlightBadWords(b);

    }catch(e){
      colorize('Ù…Ø´Ø¨ÙˆÙ‡');
      badge.textContent = LBL.unable();
      verdictWrap.hidden = false;
      addChip(LBL.netOrFormat());
    }finally{
      bar.style.width = '100%';
      setTimeout(()=> setLoading(false), 240);
    }
  }

  analyze.addEventListener('click', run);
  body.addEventListener('keydown', e=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) run(); });

  paste.addEventListener('click', async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      if(!t) return;
      const lines = t.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      if(lines.length === 1){ body.value = t; }
      else if(lines.length === 2){ sender.value = lines[0]; subject.value = lines[1]; }
      else{
        sender.value = lines[0] || '';
        subject.value = lines[1] || '';
        body.value    = lines.slice(2).join('\n');
      }
    }catch(_){}
  });

  clearB.addEventListener('click', ()=>{
    sender.value = ''; subject.value = ''; body.value = '';
    resetUI();
  });
})();
</script>
{% endblock %}
